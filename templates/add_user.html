<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>User Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
    <h1 class="mb-4">User Management</h1>

    <!-- Form إضافة مستخدم جديد -->
    <form id="userForm" class="mb-4">
        <div class="mb-3">
            <label for="net_id" class="form-label">Net ID</label>
            <input type="text" class="form-control" id="net_id" name="net_id" required />
        </div>

        <div class="mb-3">
            <label for="password" class="form-label">Password</label>
            <input type="password" class="form-control" id="password" name="password" required />
        </div>

        <div class="mb-3">
            <label for="auth_key" class="form-label">Auth Key</label>
            <input type="text" class="form-control" id="auth_key" name="auth_key" required />
        </div>

        <div class="mb-3">
            <label for="role" class="form-label">Role</label>
            <select class="form-select" id="role" name="role" required>
                <option value="admin">Admin</option>
                <option value="editor">Editor</option>
                <option value="viewer">Viewer</option>
            </select>
        </div>

        <button type="submit" class="btn btn-primary">Add User</button>
    </form>

    <p id="message" class="fw-bold"></p>

    <h2>Users Table (<span id="roleName">Admin</span>)</h2>
    <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle" id="usersTable">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Net ID</th>
                    <th>Time Added</th>
                    <th>Auth Key</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- مودال تعديل المستخدم -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalLabel">Edit User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
          <input type="hidden" id="editUserId" />
          <input type="hidden" id="editUserRole" />
          <div class="mb-3">
              <label for="editNetId" class="form-label">Net ID</label>
              <input type="text" class="form-control" id="editNetId" required />
          </div>
          <div class="mb-3">
              <label for="editPassword" class="form-label">Password (leave blank to keep current)</label>
              <input type="password" class="form-control" id="editPassword" />
          </div>
          <div class="mb-3">
              <label for="editAuthKey" class="form-label">Auth Key</label>
              <input type="text" class="form-control" id="editAuthKey" required />
          </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Save changes</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const messageEl = document.getElementById("message");
    const roleSelect = document.getElementById("role");
    const roleNameSpan = document.getElementById("roleName");
    const usersTableBody = document.querySelector("#usersTable tbody");

    const editModal = new bootstrap.Modal(document.getElementById("editModal"));
    const editForm = document.getElementById("editForm");
    const editUserIdInput = document.getElementById("editUserId");
    const editUserRoleInput = document.getElementById("editUserRole");
    const editNetIdInput = document.getElementById("editNetId");
    const editPasswordInput = document.getElementById("editPassword");
    const editAuthKeyInput = document.getElementById("editAuthKey");

    document.getElementById("userForm").addEventListener("submit", async function(event) {
        event.preventDefault();

        const role = roleSelect.value;
        const net_id = document.getElementById("net_id").value.trim();
        const password = document.getElementById("password").value.trim();
        const auth_key = document.getElementById("auth_key").value.trim();
        const time_added = new Date().toISOString();

        if (!net_id || !password || !auth_key) {
            showMessage("Please fill all required fields", "danger");
            return;
        }

        const url = `/users/add-${role}`;
        const body = { net_id, password, auth_key, time_added };

        try {
            const res = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body)
            });
            const data = await res.json();

            if (res.ok) {
                showMessage("User added successfully.", "success");
                this.reset();
                fetchUsers(role);
            } else {
                showMessage(data.error || "Error submitting form.", "danger");
            }
        } catch {
            showMessage("Network error.", "danger");
        }
    });

    roleSelect.addEventListener("change", () => {
        const role = roleSelect.value;
        roleNameSpan.textContent = role.charAt(0).toUpperCase() + role.slice(1);
        fetchUsers(role);
    });

    async function fetchUsers(role) {
        const url = `/users/${role}s`;
        usersTableBody.innerHTML = "";

        try {
            const res = await fetch(url);
            const data = await res.json();
            const users = data[`${role}s`] || [];

            if (users.length === 0) {
                usersTableBody.innerHTML = `<tr><td colspan="5" class="text-center">No users found</td></tr>`;
                return;
            }

            users.forEach(user => {
                const idField = `${role}_id`;
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${user[idField]}</td>
                    <td>${user.net_id}</td>
                    <td>${new Date(user.time_added).toLocaleString()}</td>
                    <td>${user.auth_key}</td>
                    <td>
                        <button class="btn btn-sm btn-warning me-1" onclick="openEditModal('${role}', ${user[idField]}, '${escapeHtml(user.net_id)}', '${escapeHtml(user.auth_key)}')">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser('${role}', ${user[idField]})">Delete</button>
                    </td>
                `;
                usersTableBody.appendChild(tr);
            });
        } catch {
            usersTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Failed to load users</td></tr>`;
        }
    }

    function escapeHtml(text) {
        if (!text) return "";
        return text.replace(/[&<>"']/g, m => ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;'
        })[m]);
    }

    async function deleteUser(role, id) {
        if (!confirm("Are you sure you want to delete this user?")) return;

        const url = `/users/remove-${role}/${id}`;
        try {
            const res = await fetch(url, { method: "DELETE" });
            const data = await res.json();
            if (res.ok) {
                showMessage("User deleted successfully.", "success");
                fetchUsers(roleSelect.value);
            } else {
                showMessage(data.error || "Delete failed.", "danger");
            }
        } catch {
            showMessage("Network error while deleting user.", "danger");
        }
    }

    function openEditModal(role, id, net_id, auth_key) {
        editUserIdInput.value = id;
        editUserRoleInput.value = role;
        editNetIdInput.value = net_id;
        editPasswordInput.value = "";
        editAuthKeyInput.value = auth_key;
        editModal.show();
    }

    editForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const id = editUserIdInput.value;
        const role = editUserRoleInput.value;
        const net_id = editNetIdInput.value.trim();
        const password = editPasswordInput.value.trim();
        const auth_key = editAuthKeyInput.value.trim();

        if (!net_id || !auth_key) {
            showMessage("Net ID and Auth Key are required.", "danger");
            return;
        }

        const body = { net_id, auth_key };
        if (password) body.password = password;

        const url = `/users/edit/${role}/${id}`;

        try {
            const res = await fetch(url, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body)
            });
            const data = await res.json();

            if (res.ok) {
                showMessage("User updated successfully.", "success");
                editModal.hide();
                fetchUsers(role);
            } else {
                showMessage(data.error || "Update failed.", "danger");
            }
        } catch {
            showMessage("Network error while updating user.", "danger");
        }
    });

    function showMessage(msg, type = "info") {
        messageEl.textContent = msg;
        messageEl.className = `fw-bold text-${type}`;
        setTimeout(() => {
            messageEl.textContent = "";
            messageEl.className = "";
        }, 5000);
    }

    // Load default role users on page load
    fetchUsers(roleSelect.value);
</script>

</body>
</html>
