<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>User Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    thead a {
      color: white;
      text-decoration: none;
    }

    thead a:hover {
      text-decoration: underline;
      color: #f8f9fa;
    }
  </style>
</head>
<body class="bg-light">
<div class="container mt-5">
  <h1 class="mb-4">User Management</h1>

  <!-- Add User Form -->
  <form id="userForm" class="mb-4">
    <div class="mb-3">
      <label for="net_id" class="form-label">Net ID</label>
      <input type="text" class="form-control" id="net_id" required />
    </div>
    <div class="mb-3">
      <label for="token" class="form-label">Token (min 32 chars)</label>
      <input type="text" class="form-control" id="token" required />
    </div>
    <div class="mb-3">
      <label for="role" class="form-label">Role</label>
      <select class="form-select" id="role" required>
        <option value="admin">Admin</option>
        <option value="editor">Editor</option>
        <option value="viewer">Viewer</option>
      </select>
    </div>
    <button type="submit" class="btn btn-primary">Add User</button>
  </form>

  <p id="message" class="fw-bold"></p>

  <!-- Search and Filter Row -->
  <div class="d-flex justify-content-between align-items-end mb-3">
    <div>
      <label for="searchInput" class="form-label">Search by Net ID</label>
      <div class="d-flex">
        <input type="text" class="form-control w-auto me-2" id="searchInput" placeholder="Enter Net ID" />
        <button class="btn btn-secondary" onclick="loadUsers()">Search</button>
      </div>
    </div>
    <div>
      <label for="roleFilter" class="form-label">Filter by Role</label>
      <select class="form-select w-auto" id="roleFilter">
        <option value="">All Roles</option>
        <option value="admin">Admin</option>
        <option value="editor">Editor</option>
        <option value="viewer">Viewer</option>
      </select>
    </div>
  </div>

  <h2>All Users</h2>
  <div class="table-responsive">
    <table class="table table-bordered table-striped align-middle" id="usersTable">
      <thead class="table-dark">
        <tr>
          <th><a href="#" onclick="event.preventDefault(); setSort('id')">ID <span id="sort-id"></span></a></th>
          <th><a href="#" onclick="event.preventDefault(); setSort('net_id')">Net ID <span id="sort-net_id"></span></a></th>
          <th><a href="#" onclick="event.preventDefault(); setSort('role')">Role <span id="sort-role"></span></a></th>
          <th><a href="#" onclick="event.preventDefault(); setSort('added_at')">Time Added <span id="sort-added_at"></span></a></th>
          <th>Token</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Update Modal -->
<div class="modal fade" id="updateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="updateForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Update User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="updateId" />
        <div class="mb-3">
          <label for="updateNetId" class="form-label">Net ID</label>
          <input type="text" class="form-control" id="updateNetId" required />
        </div>
        <div class="mb-3">
          <label for="updateToken" class="form-label">Token</label>
          <input type="text" class="form-control" id="updateToken" required />
        </div>
        <div class="mb-3">
          <label for="updateRole" class="form-label">Role</label>
          <select class="form-select" id="updateRole" required>
            <option value="admin">Admin</option>
            <option value="editor">Editor</option>
            <option value="viewer">Viewer</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<script>
const API_PREFIX = "/users";
const form = document.getElementById("userForm");
const messageEl = document.getElementById("message");
const usersTableBody = document.querySelector("#usersTable tbody");

let currentSortField = 'id';
let currentSortOrder = 'asc';

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const net_id = form.net_id.value.trim();
  const token = form.token.value.trim();
  const role = form.role.value;

  if (!net_id || !token || token.length < 32) {
    showMessage("Fill all fields. Token must be at least 32 characters.", "danger");
    return;
  }

  const res = await fetch(`${API_PREFIX}/add-user`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ net_id, token, role })
  });
  const data = await res.json();
  res.ok ? (showMessage("User added.", "success"), form.reset(), loadUsers()) : showMessage(data.error, "danger");
});

function setSort(field) {
  if (currentSortField === field) {
    currentSortOrder = currentSortOrder === "asc" ? "desc" : "asc";
  } else {
    currentSortField = field;
    currentSortOrder = "asc";
  }
  loadUsers();
}

async function loadUsers() {
  const role = document.getElementById("roleFilter").value;
  const search = document.getElementById("searchInput").value.trim();

  const params = new URLSearchParams();
  if (role) params.append("role", role);
  if (search) params.append("search", search);
  params.append("sort", currentSortField);
  params.append("order", currentSortOrder);

  const res = await fetch(`${API_PREFIX}/users?${params.toString()}`);
  const data = await res.json();
  usersTableBody.innerHTML = "";

  document.querySelectorAll("thead span").forEach(el => el.textContent = "");
  const arrow = currentSortOrder === "asc" ? "↑" : "↓";
  const indicator = document.getElementById(`sort-${currentSortField}`);
  if (indicator) indicator.textContent = arrow;

  data.users.forEach(user => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${user.id}</td>
      <td>${user.net_id}</td>
      <td>${user.role}</td>
      <td>${new Date(user.added_at).toLocaleString()}</td>
      <td class="text-truncate" style="max-width: 300px">${user.token}</td>
      <td>
        <button class="btn btn-warning btn-sm me-1" onclick="showUpdateModal(${user.id}, '${user.net_id}', '${user.role}', '${user.token}')">Update</button>
        <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">Delete</button>
      </td>
    `;
    usersTableBody.appendChild(row);
  });
}

function showUpdateModal(id, net_id, role, token) {
  document.getElementById("updateId").value = id;
  document.getElementById("updateNetId").value = net_id;
  document.getElementById("updateRole").value = role;
  document.getElementById("updateToken").value = token;
  new bootstrap.Modal(document.getElementById("updateModal")).show();
}

document.getElementById("updateForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const id = document.getElementById("updateId").value;
  const net_id = document.getElementById("updateNetId").value.trim();
  const role = document.getElementById("updateRole").value;
  const token = document.getElementById("updateToken").value.trim();

  const res = await fetch(`${API_PREFIX}/edit/user/${id}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ net_id, role, token })
  });
  const result = await res.json();
  showMessage(result.message || result.error, res.ok ? "success" : "danger");

  bootstrap.Modal.getInstance(document.getElementById("updateModal")).hide();
  loadUsers();
});

async function deleteUser(id) {
  if (!confirm("Are you sure you want to delete this user?")) return;

  const res = await fetch(`${API_PREFIX}/remove-user/${id}`, {
    method: "DELETE"
  });
  const result = await res.json();
  showMessage(result.message || result.error, res.ok ? "success" : "danger");
  loadUsers();
}

function showMessage(msg, type = "info") {
  messageEl.textContent = msg;
  messageEl.className = `fw-bold text-${type}`;
  setTimeout(() => {
    messageEl.textContent = "";
    messageEl.className = "";
  }, 4000);
}

document.getElementById("roleFilter").addEventListener("change", loadUsers);
loadUsers();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
