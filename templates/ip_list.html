<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Safelist IP Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
<div class="container mt-5">
    <h2 class="mb-4">Add IP to Safelist</h2>

    <form id="ipForm" class="row g-3 mb-4">
        <div class="col-md-4">
            <label for="ip_address" class="form-label">IP Address</label>
            <input type="text" class="form-control" id="ip_address" required />
        </div>
        <div class="col-md-4">
            <label for="comment" class="form-label">Comment</label>
            <input type="text" class="form-control" id="comment" />
        </div>
        <div class="col-md-2">
            <label for="duration" class="form-label">Duration (hours)</label>
            <input type="number" class="form-control" id="duration" required />
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">Add IP</button>
        </div>
    </form>

    <div id="message" class="mb-4"></div>

    <h3>Safelist Table</h3>

    <button id="deleteSelected" class="btn btn-danger mb-3" disabled>Delete Selected</button>

    <table class="table table-bordered table-striped" id="ipTable">
        <thead class="table-dark">
        <tr>
            <th><input type="checkbox" id="selectAll" /></th>
            <th>ID</th>
            <th>IP Address</th>
            <th>Comment</th>
            <th>User ID</th>
            <th>Created At</th>
            <th>Ending Date</th>
            <th>Duration (hrs)</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    async function fetchSafelist() {
        const response = await fetch('/api/safelist');
        const data = await response.json();
        const tableBody = document.querySelector('#ipTable tbody');
        tableBody.innerHTML = '';

        data.forEach(entry => {
            const row = `
                <tr>
                    <td><input type="checkbox" class="rowCheckbox" data-id="${entry.id}" /></td>
                    <td>${entry.id}</td>
                    <td>${entry.ip_address}</td>
                    <td>${entry.comment || ''}</td>
                    <td>${entry.user_id || ''}</td>
                    <td>${entry.created_at || ''}</td>
                    <td>${entry.ending_date || ''}</td>
                    <td>${entry.duration || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-warning updateBtn" data-id="${entry.id}">Update</button>
                    </td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });

        updateDeleteButtonState();

        // Add event listeners after rendering rows
        document.querySelectorAll('.updateBtn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = e.target.getAttribute('data-id');
                // Redirect to edit page (you can create this page)
                window.location.href = `/edit-ip/${id}`;
            });
        });

        document.querySelectorAll('.rowCheckbox').forEach(chk => {
            chk.addEventListener('change', updateDeleteButtonState);
        });
    }

    function updateDeleteButtonState() {
        const anyChecked = document.querySelectorAll('.rowCheckbox:checked').length > 0;
        document.getElementById('deleteSelected').disabled = !anyChecked;
    }

    document.getElementById('selectAll').addEventListener('change', function () {
        const checked = this.checked;
        document.querySelectorAll('.rowCheckbox').forEach(chk => {
            chk.checked = checked;
        });
        updateDeleteButtonState();
    });

    document.getElementById('deleteSelected').addEventListener('click', async () => {
        const checkedBoxes = [...document.querySelectorAll('.rowCheckbox:checked')];
        const ids = checkedBoxes.map(cb => cb.getAttribute('data-id'));

        if (!confirm(`Are you sure you want to delete ${ids.length} selected IP(s)?`)) {
            return;
        }

        const res = await fetch('/api/safelist/remove', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ ids })
        });

        const msgDiv = document.getElementById('message');
        const result = await res.json();
        msgDiv.className = 'alert ' + (res.ok ? 'alert-success' : 'alert-danger');
        msgDiv.textContent = result.message || result.error;

        if (res.ok) {
            fetchSafelist();
        }
    });

    document.getElementById('ipForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const ip_address = document.getElementById('ip_address').value;
        const comment = document.getElementById('comment').value;
        const duration = document.getElementById('duration').value;

        const res = await fetch('/api/safelist', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                ip_address,
                comment,
                duration,
                user_id: 1
            })
        });

        const msgDiv = document.getElementById('message');
        const result = await res.json();
        msgDiv.className = 'alert ' + (res.ok ? 'alert-success' : 'alert-danger');
        msgDiv.textContent = result.message || result.error;

        if (res.ok) {
            this.reset();
            fetchSafelist();
        }
    });

    window.onload = fetchSafelist;
</script>
</body>
</html>
