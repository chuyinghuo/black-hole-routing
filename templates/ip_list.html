<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Safelist IP Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
<div class="container mt-5">
    <h2 class="mb-4">Add IP to Safelist</h2>

    <form id="ipForm" class="row g-3 mb-4">
        <div class="col-md-4">
            <label for="ip_address" class="form-label">IP Address</label>
            <input type="text" class="form-control" id="ip_address" required />
        </div>
        <div class="col-md-4">
            <label for="comment" class="form-label">Comment</label>
            <input type="text" class="form-control" id="comment" />
        </div>
        <div class="col-md-2">
            <label for="duration" class="form-label">Duration (hours)</label>
            <input type="number" class="form-control" id="duration" required />
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">Add IP</button>
        </div>
    </form>

    <div id="message" class="mb-4"></div>

    <h3>Safelist Table</h3>

    <button id="deleteSelected" class="btn btn-danger mb-3" disabled>Delete Selected</button>

    <table class="table table-bordered table-striped" id="ipTable">
        <thead class="table-dark">
        <tr>
            <th><input type="checkbox" id="selectAll" /></th>
            <th>ID</th>
            <th>IP Address</th>
            <th>Comment</th>
            <th>User ID</th>
            <th>Created At</th>
            <th>Ending Date</th>
            <th>Duration (hrs)</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    async function fetchSafelist() {
        const response = await fetch('/safelist/api/safelist');
        const data = await response.json();
        const tableBody = document.querySelector('#ipTable tbody');
        tableBody.innerHTML = '';

        data.forEach(entry => {
            const row = `
                <tr>
                    <td><input type="checkbox" class="rowCheckbox" data-id="${entry.id}" /></td>
                    <td>${entry.id}</td>
                    <td>${entry.ip_address}</td>
                    <td>${entry.comment || ''}</td>
                    <td>${entry.user_id || ''}</td>
                    <td>${entry.created_at || ''}</td>
                    <td>${entry.ending_date || ''}</td>
                    <td>${entry.duration || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-warning updateBtn" data-id="${entry.id}">Update</button>
                    </td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });

        updateDeleteButtonState();
    }

    function updateDeleteButtonState() {
        const checkboxes = document.querySelectorAll('.rowCheckbox:checked');
        document.getElementById('deleteSelected').disabled = checkboxes.length === 0;
    }

    document.getElementById('ipForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const ip_address = document.getElementById('ip_address').value;
        const comment = document.getElementById('comment').value;
        const duration = document.getElementById('duration').value;

        const data = {
            ip_address,
            comment,
            duration,
            user_id: 1 // hardcoded or dynamic if needed
        };

        try {
            const response = await fetch('/safelist/api/safelist', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error || 'Unknown error');
            }

            const result = await response.json();
            document.getElementById('message').innerHTML = `<div class="alert alert-success">${result.message}</div>`;
            fetchSafelist();
            e.target.reset();
        } catch (err) {
            document.getElementById('message').innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
        }
    });

    // Call fetchSafelist on page load
    window.onload = fetchSafelist;

    // Event listener for checkbox changes
    document.addEventListener('change', (e) => {
        if (e.target.classList.contains('rowCheckbox')) {
            updateDeleteButtonState();
        }
    });

    // Select All functionality
    document.getElementById('selectAll').addEventListener('change', function () {
        const checkboxes = document.querySelectorAll('.rowCheckbox');
        checkboxes.forEach(cb => cb.checked = this.checked);
        updateDeleteButtonState();
    });
</script>
</body>
</html>